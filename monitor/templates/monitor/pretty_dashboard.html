{% extends 'monitor/pretty_base.html' %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å - AI System Monitor{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">üìä –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h1>
    <p class="text-gray-600">–û–±–∑–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
</div>

{% if not ssh_service.connected %}
<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
    <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-yellow-500 mr-3 text-xl"></i>
        <div>
            <h3 class="font-semibold text-yellow-800">–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</h3>
            <p class="text-yellow-700">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
        </div>
    </div>
    <div class="mt-3">
        <button onclick="connectServer()"
                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
            üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
        </button>
    </div>
</div>
{% endif %}

<!-- –ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm border p-6 text-center hover:shadow-md transition-shadow">
        <div class="text-3xl mb-2">üñ•Ô∏è</div>
        <h3 class="font-semibold text-gray-800 mb-1">–†–µ—Å—É—Ä—Å—ã</h3>
        <p class="text-gray-600 text-sm mb-3">CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫</p>
        <a href="/resources/" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors inline-block">
            –ü—Ä–æ—Å–º–æ—Ç—Ä
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-6 text-center hover:shadow-md transition-shadow">
        <div class="text-3xl mb-2">üî•</div>
        <h3 class="font-semibold text-gray-800 mb-1">–ü—Ä–æ—Ü–µ—Å—Å—ã</h3>
        <p class="text-gray-600 text-sm mb-3">–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã</p>
        <a href="/processes/" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors inline-block">
            –ü—Ä–æ—Å–º–æ—Ç—Ä
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-6 text-center hover:shadow-md transition-shadow">
        <div class="text-3xl mb-2">üê≥</div>
        <h3 class="font-semibold text-gray-800 mb-1">Docker</h3>
        <p class="text-gray-600 text-sm mb-3">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —Å–µ—Ä–≤–∏—Å—ã</p>
        <a href="/docker/" class="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-600 transition-colors inline-block">
            –ü—Ä–æ—Å–º–æ—Ç—Ä
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-sm border p-6 text-center hover:shadow-md transition-shadow">
        <div class="text-3xl mb-2">ü§ñ</div>
        <h3 class="font-semibold text-gray-800 mb-1">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
        <p class="text-gray-600 text-sm mb-3">–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑</p>
        <a href="/ai-chat/" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-600 transition-colors inline-block">
            –û—Ç–∫—Ä—ã—Ç—å
        </a>
    </div>
</div>

<!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ) -->
{% if connected %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <h3 class="text-lg font-semibold mb-4">üìà –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="space-y-4" id="quick-stats">
            <div class="flex justify-between items-center">
                <span class="text-gray-600">–°—Ç–∞—Ç—É—Å SSH:</span>
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
                <span class="text-gray-800 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">AI –ê–≥–µ–Ω—Ç:</span>
                <span class="text-gray-800 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="bg-white rounded-xl shadow-sm border p-6 lg:col-span-2">
        <h3 class="text-lg font-semibold mb-4">üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="space-y-3" id="recent-activity">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-gray-700">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
                </div>
                <span class="text-gray-500 text-sm">–¢–æ–ª—å–∫–æ —á—Ç–æ</span>
            </div>
            <div class="text-gray-500 text-center py-4" id="activity-placeholder">
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã...
            </div>
        </div>
    </div>
</div>

<!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
<div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
    <h3 class="text-lg font-semibold mb-4">üìä –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="live-metrics">
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-2xl font-bold text-gray-400">--%</div>
            <div class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ CPU</div>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-2xl font-bold text-gray-400">--%</div>
            <div class="text-sm text-gray-600">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏</div>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-2xl font-bold text-gray-400">--</div>
            <div class="text-sm text-gray-600">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</div>
        </div>
    </div>
</div>
{% endif %}

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ -->
<div class="bg-white rounded-xl shadow-sm border p-6">
    <h3 class="text-lg font-semibold mb-4">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h4 class="font-medium text-gray-800 mb-3">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã</h4>
            <ul class="space-y-2 text-gray-600">
                <li class="flex items-center space-x-2">
                    <i class="fas fa-check text-green-500"></i>
                    <span>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</span>
                </li>
                <li class="flex items-center space-x-2">
                    <i class="fas fa-check text-green-500"></i>
                    <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏</span>
                </li>
                <li class="flex items-center space-x-2">
                    <i class="fas fa-check text-green-500"></i>
                    <span>–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤</span>
                </li>
                <li class="flex items-center space-x-2">
                    <i class="fas fa-check text-green-500"></i>
                    <span>AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</span>
                </li>
            </ul>
        </div>
        <div>
            <h4 class="font-medium text-gray-800 mb-3">–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏</h4>
            <div class="space-y-2">
                <a href="/resources/" class="block p-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors">
                    üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
                </a>
                <a href="/ai-chat/" class="block p-3 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 transition-colors">
                    ü§ñ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É
                </a>
                <a href="/docker/" class="block p-3 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors">
                    üê≥ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function connectServer() {
    fetch('/api/connect/simple/', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'connected') {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + data.message);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞: ' + error);
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
function loadDashboardData() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º Docker –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    fetch('/api/docker/containers/')
        .then(response => response.json())
        .then(data => {
            console.log('üê≥ Docker –¥–∞–Ω–Ω—ã–µ:', data);

            if (data.success) {
                const running = data.running || 0;
                const total = data.total || 0;
                const stopped = data.stopped || (total - running); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–≤–Ω—ã–π stopped –µ—Å–ª–∏ –µ—Å—Ç—å

                console.log(`üê≥ Docker stats: running=${running}, total=${total}, stopped=${stopped}`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                const activityElement = document.querySelector('#activity-placeholder');
                if (activityElement) {
                    activityElement.innerHTML = `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-gray-700">Docker: ${running} –∑–∞–ø—É—â–µ–Ω–æ, ${stopped} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
                            </div>
                            <span class="text-gray-500 text-sm">–¢–æ–ª—å–∫–æ —á—Ç–æ</span>
                        </div>
                    `;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                const metricsContainer = document.querySelector('#live-metrics');
                if (metricsContainer) {
                    metricsContainer.innerHTML = `
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${total}</div>
                            <div class="text-sm text-gray-600">–í—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${running}</div>
                            <div class="text-sm text-gray-600">–ó–∞–ø—É—â–µ–Ω–æ</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600">${stopped}</div>
                            <div class="text-sm text-gray-600">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
                        </div>
                    `;
                }
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Docker –¥–∞–Ω–Ω—ã—Ö:', data.error);
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ Docker:', error);
        });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã (–æ—Ç–¥–µ–ª—å–Ω–æ)
    fetch('/api/diagnostic/resources/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const resources = data.resources;
                console.log('üìä –†–µ—Å—É—Ä—Å—ã:', resources);

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                updateProgressBars(resources);
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤:', error);
        });

    // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤
function updateProgressBars(resources) {
    // CPU –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const cpuPercent = resources.cpu_usage || 0;
    const cpuBar = document.querySelector('.cpu-progress-bar');
    if (cpuBar) {
        cpuBar.style.width = `${Math.min(cpuPercent, 100)}%`; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º—É–º 100%
        cpuBar.className = `bg-blue-500 h-3 rounded-full transition-all duration-500 cpu-progress-bar ${
            cpuPercent > 80 ? 'bg-red-500' : cpuPercent > 60 ? 'bg-yellow-500' : 'bg-blue-500'
        }`;
    }

    // Memory –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const memoryPercent = resources.memory?.usage_percent || 0;
    const memoryBar = document.querySelector('.memory-progress-bar');
    if (memoryBar) {
        memoryBar.style.width = `${Math.min(memoryPercent, 100)}%`; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º—É–º 100%
        memoryBar.className = `bg-green-500 h-3 rounded-full transition-all duration-500 memory-progress-bar ${
            memoryPercent > 80 ? 'bg-red-500' : memoryPercent > 60 ? 'bg-yellow-500' : 'bg-green-500'
        }`;
    }

    // Disk –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const diskPercent = resources.disk?.usage_percent || 0;
    const diskBar = document.querySelector('.disk-progress-bar');
    if (diskBar) {
        diskBar.style.width = `${Math.min(diskPercent, 100)}%`; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º—É–º 100%
        diskBar.className = `bg-purple-500 h-3 rounded-full transition-all duration-500 disk-progress-bar ${
            diskPercent > 90 ? 'bg-red-500' : diskPercent > 80 ? 'bg-yellow-500' : 'bg-purple-500'
        }`;
    }
}
// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    {% if connected %}
    loadDashboardData();

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadDashboardData, 30000);
    {% endif %}
});
</script>
{% endblock %}