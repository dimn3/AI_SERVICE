{% extends 'monitor/base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">üìù –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤</h1>

    <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ª–æ–≥–æ–≤ -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">üìã –¢–∏–ø—ã –ª–æ–≥–æ–≤</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <button onclick="loadLogs('system')"
                    class="bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600 text-center">
                üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
            </button>
            <button onclick="loadLogs('docker')"
                    class="bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600 text-center">
                üê≥ Docker –ª–æ–≥–∏
            </button>
            <button onclick="loadLogs('auth')"
                    class="bg-yellow-500 text-white px-4 py-3 rounded hover:bg-yellow-600 text-center">
                üîê –õ–æ–≥–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            </button>
            <button onclick="loadLogs('kernel')"
                    class="bg-red-500 text-white px-4 py-3 rounded hover:bg-red-600 text-center">
                ‚öôÔ∏è –õ–æ–≥–∏ —è–¥—Ä–∞
            </button>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:</label>
                <select id="log-lines" class="border border-gray-300 rounded px-3 py-2 w-full">
                    <option value="10">10 —Å—Ç—Ä–æ–∫</option>
                    <option value="20">20 —Å—Ç—Ä–æ–∫</option>
                    <option value="50">50 —Å—Ç—Ä–æ–∫</option>
                    <option value="100">100 —Å—Ç—Ä–æ–∫</option>
                </select>
            </div>
            <div id="service-select-container" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">–°–µ—Ä–≤–∏—Å:</label>
                <select id="log-service" class="border border-gray-300 rounded px-3 py-2 w-full">
                    <option value="">–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã</option>
                    <option value="nginx">nginx</option>
                    <option value="apache2">apache2</option>
                    <option value="mysql">mysql</option>
                    <option value="postgresql">postgresql</option>
                    <option value="docker">docker</option>
                </select>
            </div>
            <div id="container-select-container" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:</label>
                <input type="text" id="log-container" placeholder="–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
                       class="border border-gray-300 rounded px-3 py-2 w-full">
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ò–ò -->
        <div class="mt-4">
            <button onclick="analyzeLogsWithAI()"
                    class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                ü§ñ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ —Å –ò–ò
            </button>
        </div>
    </div>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ -->
    <div class="bg-white rounded-lg shadow">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-xl font-semibold" id="logs-title">–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
            <div class="space-x-2">
                <button onclick="refreshLogs()"
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button onclick="clearLogs()"
                        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    üßπ –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>
        <div id="logs-content" class="p-6">
            <div class="text-center py-12 text-gray-500">
                <p class="text-lg">üìã –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ª–æ–≥–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                <p class="text-sm mt-2">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ª–æ–≥–æ–≤</p>
            </div>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –ò–ò -->
    <div id="ai-analysis-result" class="bg-white rounded-lg shadow p-6 mt-6 hidden">
        <h3 class="text-lg font-semibold mb-4">ü§ñ –ê–Ω–∞–ª–∏–∑ –ò–ò</h3>
        <div id="ai-analysis-content"></div>
    </div>
</div>

<script>
let currentLogType = '';

function loadLogs(logType) {
    currentLogType = logType;
    const lines = document.getElementById('log-lines').value;

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById('logs-title').textContent = getLogTitle(logType);
    document.getElementById('service-select-container').classList.add('hidden');
    document.getElementById('container-select-container').classList.add('hidden');

    let url = '';
    switch(logType) {
        case 'system':
            url = `/api/logs/system/?lines=${lines}`;
            document.getElementById('service-select-container').classList.remove('hidden');
            break;
        case 'docker':
            url = `/api/logs/docker/?lines=${lines}`;
            document.getElementById('container-select-container').classList.remove('hidden');
            break;
        case 'auth':
            url = `/api/logs/auth/?lines=${lines}`;
            break;
        case 'kernel':
            url = `/api/logs/kernel/?lines=${lines}`;
            break;
    }

    htmx.ajax('GET', url, { target: '#logs-content' });
}

function getLogTitle(logType) {
    const titles = {
        'system': '–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏',
        'docker': 'Docker –ª–æ–≥–∏',
        'auth': '–õ–æ–≥–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏',
        'kernel': '–õ–æ–≥–∏ —è–¥—Ä–∞'
    };
    return titles[logType] || '–õ–æ–≥–∏';
}

function refreshLogs() {
    if (currentLogType) {
        loadLogs(currentLogType);
    }
}

function clearLogs() {
    document.getElementById('logs-content').innerHTML = `
        <div class="text-center py-8 text-gray-500">
            –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã
        </div>
    `;
}

function analyzeLogsWithAI() {
    if (!currentLogType) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ª–æ–≥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
        return;
    }

    const lines = document.getElementById('log-lines').value;
    let url = `/api/ai/analyze/logs/?type=${currentLogType}&lines=${lines}`;

    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    if (currentLogType === 'system') {
        const service = document.getElementById('log-service').value;
        if (service) url += `&service=${service}`;
    } else if (currentLogType === 'docker') {
        const container = document.getElementById('log-container').value;
        if (container) url += `&container=${container}`;
    }

    document.getElementById('ai-analysis-result').classList.remove('hidden');
    htmx.ajax('GET', url, { target: '#ai-analysis-content' });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
document.addEventListener('DOMContentLoaded', function() {
    loadLogs('system');
});
</script>

<style>
.log-entry {
    border-bottom: 1px solid #e5e7eb;
    padding: 0.5rem 0;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-error {
    color: #dc2626;
    font-weight: bold;
}

.log-warning {
    color: #d97706;
}

.log-info {
    color: #2563eb;
}

.log-debug {
    color: #6b7280;
}
</style>
{% endblock %}