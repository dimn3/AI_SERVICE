{% extends 'monitor/base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="gradient-bg text-white p-8">
            <div class="flex items-center space-x-4 mb-4">
                <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                    <i class="fas fa-robot text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold">–ò–ò –ê–≥–µ–Ω—Ç - –°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h1>
                    <p class="text-blue-100 mt-2">–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</p>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="p-6">
            <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-server text-blue-500 mr-2"></i>
                        –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
                    </h3>
                    <div id="system-status" class="text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                            <span class="text-gray-600">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-robot text-purple-500 mr-2"></i>
                        –°—Ç–∞—Ç—É—Å –ò–ò –∞–≥–µ–Ω—Ç–∞
                    </h3>
                    <div id="ai-status" class="text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                            <span class="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ß–∞—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ -->
                <div class="lg:col-span-3">
                    <div class="bg-gray-50 rounded-xl p-4 h-[500px] overflow-y-auto border" id="chat-messages">
                        <div class="text-center py-16 text-gray-500">
                            <i class="fas fa-robot text-6xl mb-4 text-gray-300"></i>
                            <p class="text-xl font-semibold mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–ò —á–∞—Ç!</p>
                            <p class="text-gray-600">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞, –∏ –ò–ò –∞–≥–µ–Ω—Ç –ø–æ–º–æ–∂–µ—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º</p>
                        </div>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
                    <div class="mt-4">
                        <form hx-post="/api/ai/chat/" hx-target="#chat-messages" hx-swap="beforeend"
                              class="flex gap-3" hx-on::after-request="this.reset()">
                            {% csrf_token %}
                            <input type="text" name="message" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ö–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞–≥—Ä—É–∂–∞—é—Ç —Å–∏—Å—Ç–µ–º—É?'..."
                                   class="flex-1 border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                   required>
                            <button type="submit"
                                    class="bg-blue-600 text-white px-8 py-3 rounded-xl hover:bg-blue-700 transition-colors font-semibold">
                                <i class="fas fa-paper-plane mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </form>
                    </div>

                    <!-- –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã -->
                    <div class="mt-6">
                        <h4 class="text-sm font-semibold text-gray-600 mb-3">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</h4>
                        <div class="grid grid-cols-2 gap-2">
                            {% for query in quick_queries %}
                            <button hx-post="/api/ai/chat/" hx-target="#chat-messages" hx-swap="beforeend"
                                    hx-vals='{"message": "{{ query }}"}'
                                    class="bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors text-left text-sm">
                                {{ query }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="space-y-4">
                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                            –ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑
                        </h3>
                        <div class="space-y-2">
                            <button hx-post="/api/ai/analyze/" hx-target="#chat-messages" hx-swap="beforeend"
                                hx-vals='{"query": "–ü—Ä–æ–≤–µ–¥–∏ –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã"}'
                                hx-headers='{"Content-Type": "application/json"}'
                                class="w-full bg-green-500 text-white px-3 py-3 rounded-lg hover:bg-green-600 transition-colors text-sm font-semibold text-left">
                                <i class="fas fa-search mr-2"></i>–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                            </button>
                            <button hx-get="/api/ai/analyze/logs/?type=system&lines=20" hx-target="#chat-messages" hx-swap="beforeend"
                                    class="w-full bg-yellow-500 text-white px-3 py-3 rounded-lg hover:bg-yellow-600 transition-colors text-sm font-semibold text-left">
                                <i class="fas fa-file-alt mr-2"></i>–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤
                            </button>
                            <button hx-get="/api/ai/analyze/docker/" hx-target="#chat-messages" hx-swap="beforeend"
                                    class="w-full bg-purple-500 text-white px-3 py-3 rounded-lg hover:bg-purple-600 transition-colors text-sm font-semibold text-left">
                                <i class="fab fa-docker mr-2"></i>–ê–Ω–∞–ª–∏–∑ Docker
                            </button>
                        </div>
                    </div>

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-history text-blue-500 mr-2"></i>
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                        </h3>
                        <div class="space-y-2">
                            <button hx-get="/api/ai/status/" hx-target="#ai-status"
                                    class="w-full bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                <i class="fas fa-sync-alt mr-2"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                            </button>
                            <button hx-get="/api/ai/history/" hx-target="#chat-messages"
                                    class="w-full bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                                <i class="fas fa-list mr-2"></i>–ò—Å—Ç–æ—Ä–∏—è
                            </button>
                            <button hx-post="/api/ai/clear-history/" hx-target="#chat-messages"
                                    class="w-full bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                                <i class="fas fa-trash mr-2"></i>–û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ -->
<div id="full-response-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden shadow-2xl">
        <div class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-blue-600 to-purple-600 text-white">
            <h3 class="text-xl font-bold">üìÑ –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –ò–ò –∞–≥–µ–Ω—Ç–∞</h3>
            <button onclick="closeFullResponse()" class="text-white hover:text-gray-200 text-2xl transition-colors">
                ‚úï
            </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh] bg-gray-50">
            <pre id="full-response-content" class="whitespace-pre-wrap text-sm font-mono bg-white p-6 rounded-lg border"></pre>
        </div>
        <div class="p-4 border-t bg-white flex justify-between items-center">
            <button onclick="copyFullResponse()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button onclick="closeFullResponse()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
</div>

<style>
.chat-message {
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    border-radius: 1rem;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}
.user-message {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    margin-left: 1rem;
    border-left: 4px solid #3b82f6;
}
.ai-message {
    background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    margin-right: 1rem;
    border-left: 4px solid #8b5cf6;
}
.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
}
.ai-response-content {
    line-height: 1.6;
}
.ai-response-content p {
    margin-bottom: 0.75rem;
}
.ai-response-content ul {
    margin-bottom: 0.75rem;
}
.ai-response-content code {
    background-color: #1f2937;
    color: #10b981;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function showFullResponse(content) {
    document.getElementById('full-response-content').textContent = content;
    document.getElementById('full-response-modal').classList.remove('hidden');
}

function closeFullResponse() {
    document.getElementById('full-response-modal').classList.add('hidden');
}

function copyFullResponse() {
    const content = document.getElementById('full-response-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('–û—Ç–≤–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
        console.log('–ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:', text);
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.target.id === 'chat-messages') {
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        const chatMessages = document.getElementById('chat-messages');
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é"
        setTimeout(() => {
            document.querySelectorAll('.show-full-btn').forEach(btn => {
                btn.onclick = function() {
                    const content = this.getAttribute('data-content');
                    showFullResponse(content);
                };
            });
        }, 150);
    }
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
    htmx.ajax('GET', '/api/status/', { target: '#system-status' });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ò–ò
    htmx.ajax('GET', '/api/ai/status/', { target: '#ai-status' });
});

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.querySelector('input[name="message"]');
    if (messageInput) {
        messageInput.focus();
    }
});
</script>
{% endblock %}