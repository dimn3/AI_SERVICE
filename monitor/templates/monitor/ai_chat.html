{% extends 'monitor/base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="bg-blue-600 text-white p-6 rounded-t-lg">
            <h1 class="text-2xl font-bold">ü§ñ –ò–ò –ê–≥–µ–Ω—Ç - –ß–∞—Ç —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</h1>
            <p class="text-blue-100 mt-2">–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ AI-–∞–Ω–∞–ª–∏–∑</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="p-6">
            <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                        <div id="system-status" class="text-sm text-gray-600">
                            –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...
                        </div>
                    </div>
                    <div class="space-x-2">
                        <button hx-get="/api/status/" hx-target="#system-status"
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">
                            –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ß–∞—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ -->
                <div class="lg:col-span-2">
                    <div class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto" id="chat-messages">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-robot text-4xl mb-4 text-gray-400"></i>
                            <p class="text-lg">üí¨ –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –ò–ò –∞–≥–µ–Ω—Ç–æ–º</p>
                            <p class="text-sm mt-2">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞</p>
                        </div>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
                    <div class="mt-4">
                        <form hx-post="/api/ai/chat/" hx-target="#chat-messages" hx-swap="beforeend" class="flex gap-2">
                            {% csrf_token %}
                            <input type="text" name="message" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Å–∏—Å—Ç–µ–º–µ..."
                                   class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                                   required>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-paper-plane mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </form>
                    </div>

                    <!-- –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã -->
                    <div class="mt-4">
                        <h4 class="text-sm font-semibold text-gray-600 mb-2">–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for query in quick_queries %}
                            <button hx-post="/api/ai/chat/" hx-target="#chat-messages" hx-swap="beforeend"
                                    hx-vals='{"message": "{{ query }}"}'
                                    class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300 transition-colors">
                                {{ query }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="space-y-4">
                    <!-- –°—Ç–∞—Ç—É—Å –ò–ò -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold mb-2 flex items-center">
                            <i class="fas fa-robot text-purple-500 mr-2"></i>
                            –°—Ç–∞—Ç—É—Å –ò–ò –∞–≥–µ–Ω—Ç–∞
                        </h3>
                        <div id="ai-status">
                            <div class="text-sm space-y-1">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                                    –ó–∞–≥—Ä—É–∑–∫–∞...
                                </div>
                            </div>
                        </div>
                        <button hx-get="/api/ai/status/" hx-target="#ai-status"
                                class="mt-2 w-full bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-200 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                        </button>
                    </div>

                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold mb-2 flex items-center">
                            <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                            –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                        </h3>
                        <div class="space-y-2">
                            <button type="button"
                                hx-post="/api/ai/analyze/"
                                hx-target="#chat-messages"
                                hx-swap="beforeend"
                                hx-vals='{"query": "–ü—Ä–æ–≤–µ–¥–∏ –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã"}'
                                class="w-full bg-green-500 text-white px-3 py-3 rounded-lg hover:bg-green-600 transition-colors text-sm font-semibold text-left">
                                <i class="fas fa-search mr-2"></i>–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                            </button>
                            <button hx-get="/api/ai/analyze/logs/?type=system&lines=20" hx-target="#chat-messages" hx-swap="beforeend"
                                    class="w-full bg-yellow-500 text-white px-3 py-2 rounded text-sm hover:bg-yellow-600 transition-colors">
                                <i class="fas fa-file-alt mr-2"></i>–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤
                            </button>
                            <button hx-get="/api/ai/analyze/docker/" hx-target="#chat-messages" hx-swap="beforeend"
                                    class="w-full bg-purple-500 text-white px-3 py-2 rounded text-sm hover:bg-purple-600 transition-colors">
                                <i class="fab fa-docker mr-2"></i>–ê–Ω–∞–ª–∏–∑ Docker
                            </button>
                        </div>
                    </div>

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold mb-2 flex items-center">
                            <i class="fas fa-history text-blue-500 mr-2"></i>
                            –ò—Å—Ç–æ—Ä–∏—è
                        </h3>
                        <div class="space-y-2">
                            <button hx-get="/api/ai/history/" hx-target="#chat-messages"
                                    class="w-full bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600 transition-colors">
                                <i class="fas fa-list mr-2"></i>–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                            </button>
                            <button hx-post="/api/ai/clear-history/" hx-target="#chat-messages"
                                    class="w-full bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600 transition-colors">
                                <i class="fas fa-trash mr-2"></i>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ -->
<div id="full-response-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">üìÑ –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –ò–ò –∞–≥–µ–Ω—Ç–∞</h3>
                <button onclick="closeFullResponse()" class="text-gray-500 hover:text-gray-700 text-xl">
                    ‚úï
                </button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[60vh]">
                <pre id="full-response-content" class="whitespace-pre-wrap text-sm font-mono bg-gray-100 p-4 rounded"></pre>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="closeFullResponse()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.chat-message {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
}
.user-message {
    background-color: #eff6ff;
    margin-left: 2rem;
    border-left: 4px solid #3b82f6;
}
.ai-message {
    background-color: #faf5ff;
    margin-right: 2rem;
    border-left: 4px solid #8b5cf6;
}
.message-header {
    font-weight: bold;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #6b7280;
}
.show-full-btn {
    background: none;
    border: none;
    color: #3b82f6;
    cursor: pointer;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}
.show-full-btn:hover {
    background-color: #3b82f6;
    color: white;
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function showFullResponse(content) {
    document.getElementById('full-response-content').textContent = content;
    document.getElementById('full-response-modal').classList.remove('hidden');
}

function closeFullResponse() {
    document.getElementById('full-response-modal').classList.add('hidden');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.target.id === 'chat-messages') {
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é"
        setTimeout(() => {
            document.querySelectorAll('.show-full-btn').forEach(btn => {
                btn.onclick = function() {
                    const content = this.getAttribute('data-content');
                    showFullResponse(content);
                };
            });
        }, 100);
    }
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
    htmx.ajax('GET', '/api/status/', { target: '#system-status' });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ò–ò
    htmx.ajax('GET', '/api/ai/status/', { target: '#ai-status' });
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø–æ Enter (—Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ)
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && e.target.form) {
        e.preventDefault();
    }
});
</script>
{% endblock %}